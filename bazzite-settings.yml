- name: Local settings
  hosts: localhost
  become: no
  vars:
    user_id: "{{ ansible_user_id }}"
  tasks:
    - name: Create required directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
      loop:
        - { path: ~/.local/share/fonts/JetBrainsMono, mode: "0755" }
        - { path: ~/.local/share/fonts/JetBrainsMonoNerdFont, mode: "0755" }
        - { path: ~/.local/share/fonts/NerdFontsSystemOnly, mode: "0755" }
    - name: Check for autogenerated fish config
      ansible.builtin.stat:
        path: ~/.config/fish
      register: fish_config
    - name: Remove autogenerated fish config
      ansible.builtin.file:
        path: ~/.config/fish
        state: absent
      when: fish_config.stat is defined and fish_config.stat.islnk is false
    - name: Initialize and apply chezmoi
      ansible.builtin.shell:
        cmd: chezmoi init --promptBool useDistrobox=true --promptString email=ulrich@feindt.dev git@github.com:ufeindt/dotfiles.git
    - name: Change user shell to fish
      become: yes
      user:
        name: "{{ user_id }}"
        shell: /usr/bin/fish
    - name: Get starship path to check if it is installed
      shell:
        cmd: which starship
      args:
        executable: /usr/bin/fish
      register: starship_path
      ignore_errors: true
      changed_when:
        - starship_path.rc == 1
        - "'which: no starship' in starship_path.stderr"
    - name: Install starship if no path
      become: yes
      ansible.builtin.shell:
        cmd: curl -sS https://starship.rs/install.sh | sudo sh -s -- -y
      when: starship_path is not defined or starship_path.stdout is not defined or starship_path.stdout == ''
    - name: Get fisher path to check if it is installed
      shell:
        cmd: fisher
      args:
        executable: /usr/bin/fish
      register: fisher_path
      ignore_errors: true
      changed_when:
        - fisher_path.rc == 1
        - "'fish: Unknown command: fisher' in fisher_path.stderr"
    - name: Install fisher if no path
      ansible.builtin.shell:
        cmd: curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher catppuccin/fish nickeb96/puffer-fish PatrickF1/fzf.fish
      args:
        executable: /usr/bin/fish
      when: fisher_path is not defined or fisher_path.stdout is not defined or fisher_path.stdout == ''
    - name: Download fonts
      ansible.builtin.unarchive:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        remote_src: yes
      loop:
        - {
            src: https://download.jetbrains.com/fonts/JetBrainsMono-2.304.zip,
            dest: ~/.local/share/fonts/JetBrainsMono,
          }
        - {
            src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/NerdFontsSymbolsOnly.zip,
            dest: ~/.local/share/fonts/NerdFontsSystemOnly,
          }
        - {
            src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/JetBrainsMono.zip,
            dest: ~/.local/share/fonts/JetBrainsMonoNerdFont,
          }
    - name: Create dev distrobox
      ansible.builtin.shell:
        cmd: distrobox create -Y --name devbox --image fedora:43 --additional-packages ansible
      args:
        executable: /usr/bin/fish
    - name: Clone my Obsidian vault
      ansible.builtin.git:
        repo: git@github.com:ufeindt/obsidian-vault.git
        dest: ~/Documents/obsidian-vault
    - name: Cache bat themes and set Catppuccin Mocha as theme
      ansible.builtin.shell:
        cmd: bat cache --build && set -U BAT_THEME "Catppuccin Mocha"
      args:
        executable: /usr/bin/fish
