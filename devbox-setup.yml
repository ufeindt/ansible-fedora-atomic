- name: Setup for devbox distrobox
  hosts: localhost
  become: no
  vars:
    user_id: "{{ ansible_user_id }}"
  tasks:
    - name: Check for autogenerated fish config
      ansible.builtin.stat:
        path: ~/.config-devbox/fish
      register: fish_config
    - name: Remove autogenerated fish config
      ansible.builtin.file:
        path: ~/.config-devbox/fish
        state: absent
      when: fish_config.stat is defined and fish_config.stat.islnk is not defined
    - name: Create symbolic links to my dotfiles
      ansible.builtin.file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
      loop:
        - { src: ~/Workspace/dotfiles/config-devbox/btop, dest: ~/.config-devbox/btop }
        - { src: ~/Workspace/dotfiles/config-devbox/fish, dest: ~/.config-devbox/fish }
        - { src: ~/Workspace/dotfiles/config-devbox/nvim, dest: ~/.config-devbox/nvim }
        - { src: ~/Workspace/dotfiles/config-devbox/starship.toml, dest: ~/.config-devbox/starship.toml }
    - name: Add Microsoft's GPG key for rpm
      become: yes
      ansible.builtin.rpm_key:
        state: present
        key: https://packages.microsoft.com/keys/microsoft.asc
    - name: Copy VS Code repo to /etc/yuom.repos.d
      become: yes
      ansible.builtin.copy:
        src: vscode.repo
        dest: /etc/yum.repos.d/vscode.repo
        owner: root
        group: root
        mode: "0644"
    - name: Install additional packages
      become: yes
      ansible.builtin.dnf:
        name:
          - btop
          - cargo
          - code
          - eza
          - fish
          - git
          - gnome-keyring
          - neovim
          - pip
          - python3.11
          - python3.12
          - rust
        state: present
    - name: Install ruff and uv via pip
      ansible.builtin.pip:
        name:
          - ruff
          - uv
    - name: Change user shell to fish
      become: yes
      user:
        name: "{{ user_id }}"
        shell: /usr/bin/fish
    - name: Get starship path to check if it is installed
      shell: 
        cmd: which starship
      args:
        executable: /usr/bin/fish
      register: starship_path
      ignore_errors: true
      changed_when: 
        - starship_path.rc == 1
        - "'which: no starship' in starship_path.stderr"
    - name: Install starship if no path
      become: yes
      ansible.builtin.shell:
        cmd: curl -sS https://starship.rs/install.sh | sudo sh -s -- -y
      when: starship_path is not defined or starship_path.stdout is not defined or starship_path.stdout == ''
    - name: Get fisher path to check if it is installed
      shell: 
        cmd: fisher
      args:
        executable: /usr/bin/fish
      register: fisher_path
      ignore_errors: true
      changed_when: 
        - fisher_path.rc == 1
        - "'fish: Unknown command: fisher' in fisher_path.stderr"
    - name: Install fisher if no path
      ansible.builtin.shell:
        cmd: curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher catppuccin/fish jorgebucaran/nvm.fish
      args:
        executable: /usr/bin/fish
      when: fisher_path is not defined or fisher_path.stdout is not defined or fisher_path.stdout == ''
    - name: Export VS code for rofi access
      ansible.builtin.shell:
        cmd: distrobox-export --app code
